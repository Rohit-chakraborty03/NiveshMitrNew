<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NiveshMitr - Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="sidebar">
        <h2>NiveshMitr</h2>
        <p id="user-email" style="font-size: 0.8em; color: #cbd5e0; margin-bottom: 30px;">Loading user...</p>
        <button class="btn-trade" onclick="location.reload()" style="background:rgba(255,255,255,0.1); margin-bottom:10px;">Refresh Dashboard</button>
        <button class="btn-trade" onclick="logout()" style="background:rgba(255,0,0,0.3); color:#ff8a80;">Logout</button>
    </div>

    <div class="main">
        <div id="debug-box">
            <strong>⚠️ Status:</strong> <span id="debug-msg">Checking...</span>
        </div>

        <div class="card" style="margin-bottom: 30px;">
            <span style="font-weight: 600;">Portfolio Summary (Available Cash)</span>
            <div id="wallet-balance" class="balance">Loading...</div>
        </div>

        <div class="grid">
            <div class="card">
                <h3>Stocks (Real-time)</h3>
                <input type="text" id="symbol" placeholder="e.g. RELIANCE.NS">
                <input type="number" id="quantity" placeholder="Quantity" min="1">
                <button class="btn-trade buy" id="buy-stock-btn" onclick="handleTrade('buy', 'stock')">Buy Stock</button>
            </div>

            <div class="card">
                <h3>Mutual Funds</h3>
                <input type="text" id="mf-symbol" placeholder="Fund Name">
                <input type="number" id="mf-quantity" placeholder="Units" min="1">
                <button class="btn-trade mf-btn" id="buy-mf-btn" onclick="handleTrade('buy_mf', 'mf')">Invest in MF</button>
            </div>

            <div class="card">
                <h3>Fixed Deposit (7% p.a.)</h3>
                <input type="number" id="fd-amount" placeholder="Amount (₹)" min="1">
                <input type="number" id="fd-months" placeholder="Duration (Months)" min="1">
                <button class="btn-trade fd-btn" id="create-fd-btn" onclick="handleFD()">Open FD</button>
            </div>
        </div>

        <h3 class="section-header">Your Stock Holdings</h3>
        <table id="holdings-table">
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Quantity</th>
                    <th>Avg Cost</th>
                    <th>P&L (%)</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="5" style="text-align:center; color:#94a3b8;">Loading...</td></tr>
            </tbody>
        </table>

        <h3 class="section-header">Active Fixed Deposits</h3>
        <table id="fd-table">
            <thead>
                <tr>
                    <th>Amount</th>
                    <th>Duration</th>
                    <th>Rate</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="4" style="text-align:center; color:#94a3b8;">Loading...</td></tr>
            </tbody>
        </table>

        <div style="text-align: center; margin-top: 50px; padding-bottom: 20px; color: #64748b; font-size: 0.85em; letter-spacing: 1px;">
            Created by team: <strong style="color: var(--accent-teal);">CODE BLOODED</strong>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Your specific Firebase credentials
        const firebaseConfig = {
            apiKey: "AIzaSyC490phLCfByyxbgpfjv804EdtSDjQUin0",
            authDomain: "nivesh-2dff0.firebaseapp.com",
            projectId: "nivesh-2dff0",
            storageBucket: "nivesh-2dff0.firebasestorage.app",
            messagingSenderId: "1098218411997",
            appId: "1:1098218411997:web:7b1a2363ad1d5c56ec0834",
            measurementId: "G-PEKDP4KZZQ"
        };

        const API_URL = "http://127.0.0.1:8000";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        function showDebug(msg) {
            const box = document.getElementById('debug-box');
            box.style.display = 'block';
            document.getElementById('debug-msg').innerText = msg;
        }

        function hideDebug() {
            document.getElementById('debug-box').style.display = 'none';
        }

        const authTimeout = setTimeout(() => {
            showDebug("Auth is taking too long. Make sure you opened this via Live Server.");
            document.getElementById('wallet-balance').innerText = "Auth Timeout";
        }, 6000);

        onAuthStateChanged(auth, async (user) => {
            clearTimeout(authTimeout);
            if (user) {
                document.getElementById('user-email').innerText = user.email || "User Logged In";
                await loadDashboardData(user.uid);
            } else {
                showDebug("Not logged in. Redirecting to login...");
                setTimeout(() => { window.location.href = "index.html"; }, 2000);
            }
        });

        async function loadDashboardData(uid) {
            try {
                // --- 1. Load Cash Balance & Handle New Users ---
                const userRef = doc(db, "users", uid);
                const userSnap = await getDoc(userRef);

                if (userSnap.exists()) {
                    const balance = userSnap.data().cashBalance ?? 0;
                    document.getElementById('wallet-balance').innerText = 
                        `₹${balance.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                } else {
                    // NEW: Strict Loop for Custom Starting Balance
                    let startingAmount = 0;
                    let isValid = false;

                    while (!isValid) {
                        let userInput = prompt("Welcome to NiveshMitr!\nHow much virtual cash do you want to start with? (Between ₹10 and ₹10,00,000)", "100000");
                        
                        // If they click 'Cancel'
                        if (userInput === null) {
                            alert("⚠️ You must enter a starting balance to set up your account.");
                            continue; // Loops back to ask again
                        }

                        let parsed = parseFloat(userInput);
                        
                        // Check if it's a number AND within range
                        if (!isNaN(parsed) && parsed >= 10 && parsed <= 1000000) {
                            startingAmount = parsed;
                            isValid = true; // Breaks the loop and continues
                        } else {
                            alert("❌ Invalid amount! Please enter a number strictly between ₹10 and ₹10,00,000.");
                        }
                    }

                    showDebug(`Setting up your profile with ₹${startingAmount.toLocaleString('en-IN')} virtual cash...`);
                    await setDoc(userRef, {
                        email: auth.currentUser.email || "",
                        cashBalance: startingAmount,
                        createdAt: new Date().toISOString()
                    });
                    document.getElementById('wallet-balance').innerText = `₹${startingAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
                    setTimeout(hideDebug, 3000);
                }

                // --- 2. Load Stock Holdings & Calculate P&L ---
                const stockSnap = await getDocs(query(collection(db, "holdings"), where("userId", "==", uid)));
                const stockBody = document.querySelector("#holdings-table tbody");
                
                if (stockSnap.empty) {
                    stockBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#94a3b8;">No holdings yet. Buy your first stock!</td></tr>`;
                } else {
                    stockBody.innerHTML = "";
                    stockSnap.docs.forEach(d => {
                        const data = d.data();
                        const rowId = `row-${d.id}`;
                        
                        stockBody.innerHTML += `<tr id="${rowId}">
                            <td><strong>${data.symbol}</strong></td>
                            <td>${data.quantity}</td>
                            <td>₹${parseFloat(data.avgPrice).toFixed(2)}</td>
                            <td class="pnl-cell" style="color:var(--text-muted); font-size: 0.9em;">Fetching live...</td>
                            <td><button onclick="handleSell('${data.symbol}', ${data.quantity})" style="color:#ff8a80; background:rgba(255,138,128,0.1); border:1px solid #ff8a80; padding:6px 15px; border-radius:6px; cursor:pointer; font-weight:bold; transition:0.3s;">Sell</button></td>
                        </tr>`;

                        // Fetch real-time price
                        fetch(`${API_URL}/price/${data.symbol}`)
                            .then(res => res.json())
                            .then(priceData => {
                                const curPrice = priceData.price;
                                const avgPrice = data.avgPrice;
                                const pnlPercent = ((curPrice - avgPrice) / avgPrice) * 100;
                                
                                const isProfit = pnlPercent >= 0;
                                const color = isProfit ? '#20c997' : '#ff8a80'; 
                                const sign = isProfit ? '+' : '';
                                
                                document.querySelector(`#${rowId} .pnl-cell`).innerHTML = `<span style="color:${color}; font-weight:bold;">${sign}${pnlPercent.toFixed(2)}%</span>`;
                            })
                            .catch(() => {
                                document.querySelector(`#${rowId} .pnl-cell`).innerHTML = `<span style="color:var(--text-muted);">Error</span>`;
                            });
                    });
                }

                // --- 3. Load Fixed Deposits ---
                const fdSnap = await getDocs(query(collection(db, "fixed_deposits"), where("userId", "==", uid)));
                const fdBody = document.querySelector("#fd-table tbody");
                if (fdSnap.empty) {
                    fdBody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:#94a3b8;">No active FDs. Open one above!</td></tr>`;
                } else {
                    fdBody.innerHTML = "";
                    fdSnap.forEach(d => {
                        const data = d.data();
                        fdBody.innerHTML += `<tr>
                            <td>₹${parseFloat(data.amount).toLocaleString('en-IN')}</td>
                            <td>${data.durationMonths} Months</td>
                            <td>${((data.rate ?? 0.07) * 100).toFixed(0)}%</td>
                            <td><span style="color:#20c997; font-weight:bold;">${data.status}</span></td>
                        </tr>`;
                    });
                }

            } catch (err) {
                showDebug(`Database Error: ${err.message}`);
                document.getElementById('wallet-balance').innerText = "Error loading data";
            }
        }

        function setBtn(id, loading, defaultText) {
            const btn = document.getElementById(id);
            if(btn) {
                btn.disabled = loading;
                btn.innerText = loading ? "Processing..." : defaultText;
            }
        }

        // --- Buy Logic ---
        window.handleTrade = async (endpoint, type) => {
            const isMF = type === 'mf';
            const sym = document.getElementById(isMF ? 'mf-symbol' : 'symbol').value.trim().toUpperCase();
            const qty = document.getElementById(isMF ? 'mf-quantity' : 'quantity').value.trim();
            const btnId = isMF ? 'buy-mf-btn' : 'buy-stock-btn';
            const defaultText = isMF ? 'Invest in MF' : 'Buy Stock';

            if (!sym || !qty || parseInt(qty) <= 0) return alert("Please fill all fields with valid values.");

            setBtn(btnId, true, defaultText);
            try {
                const res = await fetch(`${API_URL}/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: auth.currentUser.uid,
                        symbol: sym,
                        quantity: parseInt(qty)
                    })
                });
                const data = await res.json();
                alert(res.ok ? `✅ ${data.message}` : `❌ Error: ${data.detail}`);
                if (res.ok) location.reload();
            } catch (err) {
                alert("❌ Cannot connect to backend.\n\nMake sure your FastAPI server is running.");
            }
            setBtn(btnId, false, defaultText);
        };

        // --- Sell Logic ---
        window.handleSell = async (symbol, maxQty) => {
            const qtyToSell = prompt(`You own ${maxQty} shares of ${symbol}.\nHow many shares do you want to sell?`, maxQty);
            
            if (!qtyToSell || isNaN(qtyToSell) || parseInt(qtyToSell) <= 0) return;
            
            if (parseInt(qtyToSell) > maxQty) {
                return alert(`❌ You cannot sell more shares than you own! You only have ${maxQty}.`);
            }

            try {
                const res = await fetch(`${API_URL}/sell`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: auth.currentUser.uid,
                        symbol: symbol,
                        quantity: parseInt(qtyToSell)
                    })
                });
                const data = await res.json();
                alert(res.ok ? `✅ ${data.message}` : `❌ Error: ${data.detail}`);
                if (res.ok) location.reload();
            } catch (err) {
                alert("❌ Cannot connect to backend. Ensure main.py is running!");
            }
        };

        // --- FD Logic ---
        window.handleFD = async () => {
            const amt = document.getElementById('fd-amount').value.trim();
            const months = document.getElementById('fd-months').value.trim();

            if (!amt || !months || parseFloat(amt) <= 0 || parseInt(months) <= 0)
                return alert("Please enter a valid amount and duration.");

            setBtn('create-fd-btn', true, 'Open FD');
            try {
                const res = await fetch(`${API_URL}/create_fd`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: auth.currentUser.uid,
                        amount: parseFloat(amt),
                        duration_months: parseInt(months)
                    })
                });
                const data = await res.json();
                alert(res.ok ? `✅ ${data.message}` : `❌ Error: ${data.detail}`);
                if (res.ok) location.reload();
            } catch (err) {
                alert("❌ Cannot connect to backend.\n\nMake sure your FastAPI server is running.");
            }
            setBtn('create-fd-btn', false, 'Open FD');
        };

        // --- Logout ---
        window.logout = async () => {
            await signOut(auth);
            window.location.href = "index.html";
        };
    </script>
</body>
</html>