<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NiveshMitr - Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Ensures the dropdown perfectly matches your text inputs */
        select.styled-dropdown {
            background-color: rgba(15, 23, 42, 0.6);
            color: var(--text-main);
            padding: 14px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 100%;
            margin-bottom: 15px;
            box-sizing: border-box;
            outline: none;
            transition: 0.3s;
            appearance: none;
        }
        select.styled-dropdown:focus {
            border-color: var(--accent-teal);
            box-shadow: 0 0 0 2px rgba(32, 201, 151, 0.2);
            background-color: rgba(15, 23, 42, 0.8);
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>NiveshMitr</h2>
        <p id="user-email" style="font-size: 0.8em; color: #cbd5e0; margin-bottom: 30px;">Loading user...</p>
        <button class="btn-trade" onclick="location.reload()" style="background:rgba(255,255,255,0.1); margin-bottom:10px;">Refresh Dashboard</button>
        <button class="btn-trade" onclick="logout()" style="background:rgba(255,0,0,0.3); color:#ff8a80;">Logout</button>
    </div>

    <div class="main">
        <div id="debug-box">
            <strong>⚠️ Status:</strong> <span id="debug-msg">Checking...</span>
        </div>

        <div class="card" style="margin-bottom: 30px;">
            <span style="font-weight: 600;">Portfolio Summary (Available Cash)</span>
            <div id="wallet-balance" class="balance">Loading...</div>
        </div>

        <div class="grid">
            <div class="card">
                <h3>Stocks (Real-time)</h3>
                <input type="text" id="symbol" placeholder="e.g. RELIANCE.NS">
                <input type="number" id="quantity" placeholder="Quantity" min="1">
                <button class="btn-trade buy" id="buy-stock-btn" onclick="handleTrade('buy', 'stock')">Buy Stock</button>
            </div>

            <div class="card">
                <h3>Mutual Funds</h3>
                <select id="mf-symbol" class="styled-dropdown">
                    <option value="" disabled selected>Loading live prices...</option>
                </select>
                <input type="number" id="mf-quantity" placeholder="Units" min="1">
                <button class="btn-trade mf-btn" id="buy-mf-btn" onclick="handleTrade('buy_mf', 'mf')">Invest in MF</button>
            </div>

            <div class="card">
                <h3>Fixed Deposit (7% p.a.)</h3>
                <input type="number" id="fd-amount" placeholder="Amount (₹)" min="1">
                <input type="number" id="fd-months" placeholder="Duration (Months)" min="1">
                <button class="btn-trade fd-btn" id="create-fd-btn" onclick="handleFD()">Open FD</button>
            </div>
        </div>

        <h3 class="section-header">Your Stock Holdings</h3>
        <table id="holdings-table">
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Quantity</th>
                    <th>Avg Cost</th>
                    <th>P&L (%)</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="5" style="text-align:center; color:#94a3b8;">Loading...</td></tr>
            </tbody>
        </table>

        <h3 class="section-header">Your Mutual Fund Holdings</h3>
        <table id="mf-table">
            <thead>
                <tr>
                    <th>Fund Name</th>
                    <th>Units</th>
                    <th>Avg NAV</th>
                    <th>P&L (%)</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="5" style="text-align:center; color:#94a3b8;">Loading...</td></tr>
            </tbody>
        </table>

        <h3 class="section-header">Active Fixed Deposits</h3>
        <table id="fd-table">
            <thead>
                <tr>
                    <th>Amount</th>
                    <th>Duration</th>
                    <th>Rate</th>
                    <th>Maturity Value</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="5" style="text-align:center; color:#94a3b8;">Loading...</td></tr>
            </tbody>
        </table>

        <div style="text-align: center; margin-top: 50px; padding-bottom: 20px; color: #64748b; font-size: 0.85em; letter-spacing: 1px;">
            Created by team: <strong style="color: var(--accent-teal);">CODE BLOODED</strong>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC490phLCfByyxbgpfjv804EdtSDjQUin0",
            authDomain: "nivesh-2dff0.firebaseapp.com",
            projectId: "nivesh-2dff0",
            storageBucket: "nivesh-2dff0.firebasestorage.app",
            messagingSenderId: "1098218411997",
            appId: "1:1098218411997:web:7b1a2363ad1d5c56ec0834",
            measurementId: "G-PEKDP4KZZQ"
        };

        const API_URL = "http://127.0.0.1:8000";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Predefined list of Top Indian Mutual Funds (Using ETFs for live Yahoo Finance data)
        const availableMFs = [
            { symbol: "SETFNIF50.NS", name: "SBI Nifty 50 ETF" },
            { symbol: "GOLDBEES.NS", name: "Nippon India Gold ETF" },
            { symbol: "LIQUIDBEES.NS", name: "HDFC Liquid ETF" },
            { symbol: "ICICINIFTY.NS", name: "ICICI Prudential Nifty ETF" },
            { symbol: "KOTAKALPHA.NS", name: "Kotak Alpha 50 ETF" }
        ];

        // Fetch Live Prices for the Dropdown
        async function loadMFDropdown() {
            const mfSelect = document.getElementById('mf-symbol');
            mfSelect.innerHTML = '<option value="" disabled selected>Loading live prices...</option>';
            
            let optionsHTML = '';
            for (let mf of availableMFs) {
                try {
                    const res = await fetch(`${API_URL}/price/${mf.symbol}`);
                    const data = await res.json();
                    optionsHTML += `<option value="${mf.symbol}">${mf.name} (₹${data.price.toFixed(2)})</option>`;
                } catch (e) {
                    optionsHTML += `<option value="${mf.symbol}">${mf.name} (Price unavailable)</option>`;
                }
            }
            mfSelect.innerHTML = '<option value="" disabled selected>Select Mutual Fund</option>' + optionsHTML;
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('user-email').innerText = user.email || "User Logged In";
                loadMFDropdown(); // Start loading dropdown prices immediately
                await loadDashboardData(user.uid);
            } else {
                setTimeout(() => { window.location.href = "index.html"; }, 1000);
            }
        });

        async function loadDashboardData(uid) {
            try {
                // --- 1. Load Cash Balance ---
                const userRef = doc(db, "users", uid);
                const userSnap = await getDoc(userRef);

                if (userSnap.exists()) {
                    const balance = userSnap.data().cashBalance ?? 0;
                    document.getElementById('wallet-balance').innerText = `₹${balance.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                } else {
                    let startingAmount = 0;
                    let isValid = false;
                    while (!isValid) {
                        let userInput = prompt("Welcome to NiveshMitr!\nHow much virtual cash do you want to start with? (Between ₹10 and ₹10,00,000)", "100000");
                        if (userInput === null) { alert("⚠️ You must enter a starting balance."); continue; }
                        let parsed = parseFloat(userInput);
                        if (!isNaN(parsed) && parsed >= 10 && parsed <= 1000000) { startingAmount = parsed; isValid = true; } 
                        else { alert("❌ Invalid amount! Please enter a number strictly between ₹10 and ₹10,00,000."); }
                    }
                    await setDoc(userRef, { email: auth.currentUser.email || "", cashBalance: startingAmount, createdAt: new Date().toISOString() });
                    document.getElementById('wallet-balance').innerText = `₹${startingAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
                }

                // --- 2. Load Stock Holdings ---
                const stockSnap = await getDocs(query(collection(db, "holdings"), where("userId", "==", uid)));
                const stockBody = document.querySelector("#holdings-table tbody");
                
                if (stockSnap.empty) {
                    stockBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#94a3b8;">No holdings yet. Buy your first stock!</td></tr>`;
                } else {
                    stockBody.innerHTML = "";
                    stockSnap.docs.forEach(d => {
                        const data = d.data();
                        const rowId = `row-${d.id}`;
                        
                        stockBody.innerHTML += `<tr id="${rowId}">
                            <td><strong>${data.symbol}</strong></td>
                            <td>${data.quantity}</td>
                            <td>₹${parseFloat(data.avgPrice).toFixed(2)}</td>
                            <td class="pnl-cell" style="color:var(--text-muted); font-size: 0.9em;">Fetching live...</td>
                            <td><button onclick="handleSell('${data.symbol}', ${data.quantity})" style="color:#ff8a80; background:rgba(255,138,128,0.1); border:1px solid #ff8a80; padding:6px 15px; border-radius:6px; cursor:pointer; font-weight:bold;">Sell</button></td>
                        </tr>`;

                        fetch(`${API_URL}/price/${data.symbol}`)
                            .then(res => res.json())
                            .then(priceData => {
                                const pnlPercent = ((priceData.price - data.avgPrice) / data.avgPrice) * 100;
                                const color = pnlPercent >= 0 ? '#20c997' : '#ff8a80'; 
                                const sign = pnlPercent >= 0 ? '+' : '';
                                document.querySelector(`#${rowId} .pnl-cell`).innerHTML = `<span style="color:${color}; font-weight:bold;">${sign}${pnlPercent.toFixed(2)}%</span>`;
                            }).catch(() => { document.querySelector(`#${rowId} .pnl-cell`).innerHTML = `<span style="color:var(--text-muted);">Error</span>`; });
                    });
                }

                // --- 3. Load Mutual Fund Holdings ---
                const mfSnap = await getDocs(query(collection(db, "mutual_funds"), where("userId", "==", uid)));
                const mfBody = document.querySelector("#mf-table tbody");
                
                if (mfSnap.empty) {
                    mfBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#94a3b8;">No mutual funds yet. Start investing!</td></tr>`;
                } else {
                    mfBody.innerHTML = "";
                    mfSnap.docs.forEach(d => {
                        const data = d.data();
                        const rowId = `mf-row-${d.id}`;
                        
                        // Find the pretty name from our array
                        const fundObj = availableMFs.find(f => f.symbol === data.fundName);
                        const displayName = fundObj ? fundObj.name : data.fundName;
                        
                        mfBody.innerHTML += `<tr id="${rowId}">
                            <td><strong>${displayName}</strong><br><small style="color:var(--text-muted);">${data.fundName}</small></td>
                            <td>${data.units}</td>
                            <td>₹${parseFloat(data.navAtPurchase).toFixed(2)}</td>
                            <td class="pnl-cell" style="color:var(--text-muted); font-size: 0.9em;">Fetching live...</td>
                            <td><button onclick="handleSellMF('${data.fundName}', ${data.units})" style="color:#ff8a80; background:rgba(255,138,128,0.1); border:1px solid #ff8a80; padding:6px 15px; border-radius:6px; cursor:pointer; font-weight:bold;">Sell</button></td>
                        </tr>`;

                        fetch(`${API_URL}/price/${data.fundName}`)
                            .then(res => res.json())
                            .then(priceData => {
                                const pnlPercent = ((priceData.price - data.navAtPurchase) / data.navAtPurchase) * 100;
                                const color = pnlPercent >= 0 ? '#20c997' : '#ff8a80'; 
                                const sign = pnlPercent >= 0 ? '+' : '';
                                document.querySelector(`#${rowId} .pnl-cell`).innerHTML = `<span style="color:${color}; font-weight:bold;">${sign}${pnlPercent.toFixed(2)}%</span>`;
                            }).catch(() => { document.querySelector(`#${rowId} .pnl-cell`).innerHTML = `<span style="color:var(--text-muted);">Error</span>`; });
                    });
                }

                // --- 4. Load Fixed Deposits ---
                const fdSnap = await getDocs(query(collection(db, "fixed_deposits"), where("userId", "==", uid)));
                const fdBody = document.querySelector("#fd-table tbody");
                
                if (fdSnap.empty) {
                    fdBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#94a3b8;">No active FDs.</td></tr>`;
                } else {
                    fdBody.innerHTML = "";
                    fdSnap.forEach(d => {
                        const data = d.data();
                        const principal = parseFloat(data.amount);
                        const rate = data.rate ?? 0.07;
                        const maturityValue = principal + (principal * rate * (parseInt(data.durationMonths) / 12));

                        fdBody.innerHTML += `<tr>
                            <td>₹${principal.toLocaleString('en-IN')}</td>
                            <td>${data.durationMonths} Months</td>
                            <td>${(rate * 100).toFixed(0)}%</td>
                            <td style="color: var(--accent-blue); font-weight: bold;">₹${maturityValue.toLocaleString('en-IN', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                            <td><span style="color:#20c997; font-weight:bold;">${data.status}</span></td>
                        </tr>`;
                    });
                }

            } catch (err) {
                console.error(err);
                document.getElementById('wallet-balance').innerText = "Error loading data";
            }
        }

        function setBtn(id, loading, defaultText) {
            const btn = document.getElementById(id);
            if(btn) { btn.disabled = loading; btn.innerText = loading ? "Processing..." : defaultText; }
        }

        // --- Buy Logic ---
        window.handleTrade = async (endpoint, type) => {
            const isMF = type === 'mf';
            // Getting the value from the dropdown if it's MF, otherwise text input
            const sym = document.getElementById(isMF ? 'mf-symbol' : 'symbol').value.trim().toUpperCase();
            const qty = document.getElementById(isMF ? 'mf-quantity' : 'quantity').value.trim();
            const btnId = isMF ? 'buy-mf-btn' : 'buy-stock-btn';
            const defaultText = isMF ? 'Invest in MF' : 'Buy Stock';

            if (!sym || !qty || parseInt(qty) <= 0) return alert("Please select a valid option and quantity.");

            setBtn(btnId, true, defaultText);
            try {
                const res = await fetch(`${API_URL}/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: auth.currentUser.uid, symbol: sym, quantity: parseInt(qty) })
                });
                const data = await res.json();
                alert(res.ok ? `✅ ${data.message}` : `❌ Error: ${data.detail}`);
                if (res.ok) location.reload();
            } catch (err) { alert("❌ Cannot connect to backend."); }
            setBtn(btnId, false, defaultText);
        };

        // --- Sell Stock Logic ---
        window.handleSell = async (symbol, maxQty) => {
            const qtyToSell = prompt(`You own ${maxQty} shares of ${symbol}.\nHow many shares do you want to sell?`, maxQty);
            if (!qtyToSell || isNaN(qtyToSell) || parseInt(qtyToSell) <= 0) return;
            if (parseInt(qtyToSell) > maxQty) return alert(`❌ You cannot sell more shares than you own!`);

            try {
                const res = await fetch(`${API_URL}/sell`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: auth.currentUser.uid, symbol: symbol, quantity: parseInt(qtyToSell) })
                });
                const data = await res.json();
                alert(res.ok ? `✅ ${data.message}` : `❌ Error: ${data.detail}`);
                if (res.ok) location.reload();
            } catch (err) { alert("❌ Cannot connect to backend."); }
        };

        // --- Sell MF Logic ---
        window.handleSellMF = async (symbol, maxQty) => {
            const qtyToSell = prompt(`You own ${maxQty} units.\nHow many units do you want to sell?`, maxQty);
            if (!qtyToSell || isNaN(qtyToSell) || parseInt(qtyToSell) <= 0) return;
            if (parseInt(qtyToSell) > maxQty) return alert(`❌ You cannot sell more units than you own!`);

            try {
                const res = await fetch(`${API_URL}/sell_mf`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: auth.currentUser.uid, symbol: symbol, quantity: parseInt(qtyToSell) })
                });
                const data = await res.json();
                alert(res.ok ? `✅ ${data.message}` : `❌ Error: ${data.detail}`);
                if (res.ok) location.reload();
            } catch (err) { alert("❌ Cannot connect to backend."); }
        };

        // --- FD Logic ---
        window.handleFD = async () => {
            const amt = document.getElementById('fd-amount').value.trim();
            const months = document.getElementById('fd-months').value.trim();
            if (!amt || !months || parseFloat(amt) <= 0 || parseInt(months) <= 0) return alert("Please enter valid details.");

            setBtn('create-fd-btn', true, 'Open FD');
            try {
                const res = await fetch(`${API_URL}/create_fd`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: auth.currentUser.uid, amount: parseFloat(amt), duration_months: parseInt(months) })
                });
                const data = await res.json();
                alert(res.ok ? `✅ ${data.message}` : `❌ Error: ${data.detail}`);
                if (res.ok) location.reload();
            } catch (err) { alert("❌ Cannot connect to backend."); }
            setBtn('create-fd-btn', false, 'Open FD');
        };

        window.logout = async () => {
            await signOut(auth);
            window.location.href = "index.html";
        };
    </script>
</body>
</html>