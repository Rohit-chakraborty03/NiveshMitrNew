<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NiveshMitr - Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
    <script>
        const currentTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', currentTheme);
        
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const target = current === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', target);
            localStorage.setItem('theme', target);
            document.getElementById('theme-btn').innerText = target === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
        }
    </script>
</head>
<body class="dashboard-body">

    <div class="navbar">
        <h2 style="margin: 0; font-size: 24px;"><span class="logo-icon" style="font-size: 24px;">üí†</span> NiveshMitr</h2>
        <div class="nav-buttons">
            <span id="user-email" style="font-size: 14px; color: var(--text-muted); margin-right: 15px;">Loading...</span>
            <button id="theme-btn" onclick="toggleTheme()">üåô Dark</button>
            <button onclick="location.reload()">Refresh</button>
            <button onclick="logout()" style="color: #ff4d4d; border-color: #ff4d4d;">Logout</button>
        </div>
    </div>

    <div class="container">
        
        <div class="card" style="margin-bottom: 20px; background-color: var(--learning-bg); border-left: 4px solid var(--learning-border);">
            <h3 style="margin-top: 0; color: var(--accent-blue);">üìö Student Learning Center</h3>
            <details>
                <summary>üìà What are Stocks?</summary>
                <p><strong>Definition:</strong> A stock represents a tiny fraction of ownership in a real company.<br>
                <strong>How it works:</strong> You make money by selling your shares at a higher price than you bought them!</p>
            </details>
            <details>
                <summary>üß∫ What are Mutual Funds?</summary>
                <p><strong>Definition:</strong> A mutual fund is like a basket of many different stocks managed by an expert.<br>
                <strong>How it works:</strong> It is much safer than buying a single stock because if one company fails, the others in the basket protect your money.</p>
            </details>
            <details>
                <summary>‚ö° What is F&O Trading?</summary>
                <p><strong>Definition:</strong> F&O are advanced contracts where you bet on market direction.<br>
                <strong>How it works:</strong> If you think Nifty will go UP, buy a <b>Call (CE)</b>. If DOWN, buy a <b>Put (PE)</b>. Very risky!</p>
            </details>
        </div>

        <div class="balance-box">
            <p style="margin: 0; color: var(--text-muted); text-transform: uppercase; font-size: 12px; letter-spacing: 1px;">Available Virtual Cash</p>
            <h1 id="wallet-balance" style="margin: 10px 0; font-size: 42px;">Loading...</h1>
        </div>

        <div class="grid">
            <div class="card">
                <h3>Buy Stocks</h3>
                <input type="text" id="symbol" class="input-box" style="width: 90%;" placeholder="Ticker (e.g. RELIANCE.NS)">
                <input type="number" id="quantity" class="input-box" style="width: 90%;" placeholder="Quantity" min="1">
                <button class="btn-black" id="buy-stock-btn" style="width: 100%;" onclick="handleTrade('buy', 'stock')">Buy Stock</button>
            </div>

            <div class="card">
                <h3>Futures & Options</h3>
                <select id="fo-symbol" class="input-box" style="width: 95%;">
                    <option value="^NSEI">NIFTY 50</option>
                    <option value="^NSEBANK">BANK NIFTY</option>
                </select><br>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <select id="fo-type" class="input-box" style="width: 50%; margin-bottom: 0;">
                        <option value="CE">Call (CE)</option>
                        <option value="PE">Put (PE)</option>
                    </select>
                    <input type="number" id="fo-lots" class="input-box" style="width: 40%; margin-bottom: 0;" placeholder="Lots" min="1">
                </div>
                <button class="btn-black" id="buy-fo-btn" style="width: 100%;" onclick="handleFOTrade()">Buy Contract (‚Çπ5k/lot)</button>
            </div>

            <div class="card">
                <h3>Mutual Funds</h3>
                <select id="mf-symbol" class="input-box" style="width: 95%;">
                    <option value="" disabled selected>Loading...</option>
                </select>
                <input type="number" id="mf-quantity" class="input-box" style="width: 90%;" placeholder="Units" min="1">
                <button class="btn-black" id="buy-mf-btn" style="width: 100%;" onclick="handleTrade('buy_mf', 'mf')">Invest in MF</button>
            </div>
            
            <div class="card">
                <h3>Fixed Deposit (7%)</h3>
                <input type="number" id="fd-amount" class="input-box" style="width: 90%;" placeholder="Amount (‚Çπ)" min="1">
                <input type="number" id="fd-months" class="input-box" style="width: 90%;" placeholder="Months" min="1">
                <button class="btn-black" id="create-fd-btn" style="width: 100%;" onclick="handleFD()">Open FD</button>
            </div>
        </div>

        <h3>Your Stock Holdings</h3>
        <table id="holdings-table">
            <thead><tr><th>Symbol</th><th>Qty</th><th>Avg Cost</th><th>Live Price</th><th>P&L</th><th>Action</th></tr></thead>
            <tbody><tr><td colspan="6" align="center">Loading...</td></tr></tbody>
        </table>

        <h3>Your F/O Positions</h3>
        <table id="fo-table">
            <thead><tr><th>Index</th><th>Type</th><th>Lots</th><th>Entry Index</th><th>Live Index</th><th>P&L (‚Çπ)</th><th>Action</th></tr></thead>
            <tbody><tr><td colspan="7" align="center">Loading...</td></tr></tbody>
        </table>

        <h3>Your Mutual Funds</h3>
        <table id="mf-table">
            <thead><tr><th>Fund Name</th><th>Units</th><th>Avg NAV</th><th>Live NAV</th><th>P&L</th><th>Action</th></tr></thead>
            <tbody><tr><td colspan="6" align="center">Loading...</td></tr></tbody>
        </table>

        <h3>Active Fixed Deposits</h3>
        <table id="fd-table">
            <thead><tr><th>Amount</th><th>Duration</th><th>Rate</th><th>Maturity Value</th><th>Status</th></tr></thead>
            <tbody><tr><td colspan="5" align="center">Loading...</td></tr></tbody>
        </table>

        <p style="text-align: center; color: var(--text-muted); margin-top: 40px; font-size: 12px;">Created by Team: <strong>CODE BLOODED</strong></p>
    </div>

    <script type="module">
        //toggle text on load.
        document.getElementById('theme-btn').innerText = document.documentElement.getAttribute('data-theme') === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC490phLCfByyxbgpfjv804EdtSDjQUin0", 
            authDomain: "nivesh-2dff0.firebaseapp.com", 
            projectId: "nivesh-2dff0",
            storageBucket: "nivesh-2dff0.firebasestorage.app", 
            messagingSenderId: "1098218411997", 
            appId: "1:1098218411997:web:7b1a2363ad1d5c56ec0834", 
            measurementId: "G-PEKDP4KZZQ"
        };
        
        const API_URL = "http://127.0.0.1:8000";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const availableMFs = [
            { symbol: "SETFNIF50.NS", name: "SBI Nifty 50 ETF" },
            { symbol: "GOLDBEES.NS", name: "Nippon India Gold ETF" },
            { symbol: "LIQUIDBEES.NS", name: "HDFC Liquid ETF" }
        ];

        let liveUpdateInterval;
        let globalStockDocs = [];
        let globalMFDocs = [];
        let globalFODocs = [];

        async function loadMFDropdown() {
            const mfSelect = document.getElementById('mf-symbol');
            let optionsHTML = '';
            for (let mf of availableMFs) {
                try {
                    const res = await fetch(`${API_URL}/price/${mf.symbol}`);
                    const data = await res.json();
                    optionsHTML += `<option value="${mf.symbol}">${mf.name} (‚Çπ${data.price.toFixed(2)})</option>`;
                } catch (e) { optionsHTML += `<option value="${mf.symbol}">${mf.name}</option>`; }
            }
            mfSelect.innerHTML = '<option value="" disabled selected>Select Mutual Fund</option>' + optionsHTML;
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('user-email').innerText = user.email || "Logged In";
                loadMFDropdown(); 
                await loadDashboardData(user.uid);
            } else { setTimeout(() => { window.location.href = "index.html"; }, 1000); }
        });

        async function loadDashboardData(uid) {
            if(liveUpdateInterval) clearInterval(liveUpdateInterval);

            try {
                const userRef = doc(db, "users", uid);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    document.getElementById('wallet-balance').innerText = `‚Çπ${(userSnap.data().cashBalance ?? 0).toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
                } else {
                    let startingAmount = 0; let isValid = false;
                    while (!isValid) {
                        let userInput = prompt("Welcome to NiveshMitr!\nHow much virtual cash do you want to start with?", "100000");
                        if (userInput === null) { alert("Please enter an amount."); continue; }
                        let parsed = parseFloat(userInput);
                        if (!isNaN(parsed) && parsed >= 10 && parsed <= 1000000) { startingAmount = parsed; isValid = true; } else { alert("Invalid amount."); }
                    }
                    await setDoc(userRef, { email: auth.currentUser.email || "", cashBalance: startingAmount, createdAt: new Date().toISOString() });
                    document.getElementById('wallet-balance').innerText = `‚Çπ${startingAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
                }
            } catch (err) { console.error(err); }

            // Stocks Table
            const stockBody = document.querySelector("#holdings-table tbody");
            try {
                const stockSnap = await getDocs(query(collection(db, "holdings"), where("userId", "==", uid)));
                globalStockDocs = stockSnap.docs;
                if (stockSnap.empty) { stockBody.innerHTML = `<tr><td colspan="6" align="center" style="color:var(--text-muted);">No holdings.</td></tr>`; } 
                else {
                    stockBody.innerHTML = "";
                    stockSnap.docs.forEach(d => {
                        const data = d.data();
                        const safeAvgCost = parseFloat(data.avgPrice) || 0; 
                        stockBody.innerHTML += `<tr id="row-${d.id}">
                            <td><b>${data.symbol}</b></td><td>${data.quantity}</td><td>‚Çπ${safeAvgCost.toFixed(2)}</td>
                            <td id="live-price-${d.id}">...</td><td id="pnl-${d.id}">...</td>
                            <td><button class="sell-btn" onclick="handleSell('${data.symbol}', ${data.quantity})">Sell</button></td>
                        </tr>`;
                    });
                }
            } catch (err) { stockBody.innerHTML = `<tr><td colspan="6" align="center" style="color:red;">Error: ${err.message}</td></tr>`; }

            // F/O Table
            const foBody = document.querySelector("#fo-table tbody");
            try {
                const foSnap = await getDocs(query(collection(db, "fo_holdings"), where("userId", "==", uid)));
                globalFODocs = foSnap.docs;
                if (foSnap.empty) { foBody.innerHTML = `<tr><td colspan="7" align="center" style="color:var(--text-muted);">No active contracts.</td></tr>`; } 
                else {
                    foBody.innerHTML = "";
                    foSnap.docs.forEach(d => {
                        const data = d.data();
                        const name = data.symbol === "^NSEI" ? "NIFTY 50" : "BANK NIFTY";
                        const safeEntry = parseFloat(data.entryPrice) || 0; 
                        foBody.innerHTML += `<tr id="fo-${d.id}">
                            <td><b>${name}</b></td><td>${data.optionType}</td><td>${data.lots} (${data.lots * data.lotSize} qty)</td>
                            <td>${safeEntry.toFixed(2)}</td><td id="fo-live-${d.id}">...</td><td id="fo-pnl-${d.id}">...</td>
                            <td><button class="sell-btn" onclick="handleCloseFO('${data.symbol}', '${data.optionType}')">Close</button></td>
                        </tr>`;
                    });
                }
            } catch (err) { foBody.innerHTML = `<tr><td colspan="7" align="center" style="color:red;">Error: ${err.message}</td></tr>`; }

            // Mutual Funds Table
            const mfBody = document.querySelector("#mf-table tbody");
            try {
                const mfSnap = await getDocs(query(collection(db, "mutual_funds"), where("userId", "==", uid)));
                globalMFDocs = mfSnap.docs;
                if (mfSnap.empty) { mfBody.innerHTML = `<tr><td colspan="6" align="center" style="color:var(--text-muted);">No mutual funds yet.</td></tr>`; } 
                else {
                    mfBody.innerHTML = "";
                    mfSnap.docs.forEach(d => {
                        const data = d.data();
                        const fundObj = availableMFs.find(f => f.symbol === data.fundName);
                        const displayName = fundObj ? fundObj.name : data.fundName;
                        const safeNav = parseFloat(data.navAtPurchase) || 0;
                        mfBody.innerHTML += `<tr id="mf-row-${d.id}">
                            <td><b>${displayName}</b><br><small style="color:var(--text-muted);">${data.fundName}</small></td>
                            <td>${data.units}</td><td>‚Çπ${safeNav.toFixed(2)}</td>
                            <td id="mf-live-price-${d.id}">...</td><td id="mf-pnl-${d.id}">...</td>
                            <td><button class="sell-btn" onclick="handleSellMF('${data.fundName}', ${data.units})">Sell</button></td>
                        </tr>`;
                    });
                }
            } catch (err) { mfBody.innerHTML = `<tr><td colspan="6" align="center" style="color:red;">Error: ${err.message}</td></tr>`; }

            // Deposits Table
            const fdBody = document.querySelector("#fd-table tbody");
            try {
                const fdSnap = await getDocs(query(collection(db, "fixed_deposits"), where("userId", "==", uid)));
                if (fdSnap.empty) { fdBody.innerHTML = `<tr><td colspan="5" align="center" style="color:var(--text-muted);">No active FDs.</td></tr>`; } 
                else {
                    fdBody.innerHTML = "";
                    fdSnap.docs.forEach(d => {
                        const data = d.data();
                        const principal = parseFloat(data.amount) || 0;
                        const rate = parseFloat(data.rate) || 0.07;
                        const maturityValue = principal + (principal * rate * (parseInt(data.durationMonths) / 12));
                        fdBody.innerHTML += `<tr>
                            <td>‚Çπ${principal.toLocaleString('en-IN')}</td><td>${data.durationMonths} Months</td><td>${(rate * 100).toFixed(0)}%</td>
                            <td><b>‚Çπ${maturityValue.toLocaleString('en-IN', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</b></td>
                            <td style="color:#10b981; font-weight:bold;">${data.status}</td>
                        </tr>`;
                    });
                }
            } catch (err) { fdBody.innerHTML = `<tr><td colspan="5" align="center" style="color:red;">Error: ${err.message}</td></tr>`; }

            const fetchLivePrices = () => {
                globalStockDocs.forEach(d => {
                    const data = d.data();
                    fetch(`${API_URL}/price/${data.symbol}`).then(res => res.json()).then(p => {
                        if(p.price === undefined) return; 
                        const safeAvg = parseFloat(data.avgPrice) || 0;
                        const pnl = ((p.price - safeAvg) / safeAvg) * 100;
                        const el = document.getElementById(`live-price-${d.id}`);
                        if(el) {
                            el.innerText = `‚Çπ${p.price.toFixed(2)}`;
                            let pnlHTML = `<span style="color:${pnl>=0?'#10b981':'#ef4444'}; font-weight:bold;">${pnl>=0?'+':''}${pnl.toFixed(2)}%</span>`;
                            if(pnl < 0) pnlHTML += `<button class="why-btn" onclick="showLossReason('stock')">‚ùì Why?</button>`;
                            document.getElementById(`pnl-${d.id}`).innerHTML = pnlHTML;
                            el.classList.remove("updating"); void el.offsetWidth; el.classList.add("updating");
                        }
                    }).catch(e => console.log("Fetch error"));
                });

                globalMFDocs.forEach(d => {
                    const data = d.data();
                    fetch(`${API_URL}/price/${data.fundName}`).then(res => res.json()).then(p => {
                        if(p.price === undefined) return;
                        const safeNav = parseFloat(data.navAtPurchase) || 0;
                        const pnl = ((p.price - safeNav) / safeNav) * 100;
                        const el = document.getElementById(`mf-live-price-${d.id}`);
                        if(el) {
                            el.innerText = `‚Çπ${p.price.toFixed(2)}`;
                            let pnlHTML = `<span style="color:${pnl>=0?'#10b981':'#ef4444'}; font-weight:bold;">${pnl>=0?'+':''}${pnl.toFixed(2)}%</span>`;
                            if(pnl < 0) pnlHTML += `<button class="why-btn" onclick="showLossReason('mf')">‚ùì Why?</button>`;
                            document.getElementById(`mf-pnl-${d.id}`).innerHTML = pnlHTML;
                            el.classList.remove("updating"); void el.offsetWidth; el.classList.add("updating");
                        }
                    }).catch(e => console.log("Fetch error"));
                });

                globalFODocs.forEach(d => {
                    const data = d.data();
                    fetch(`${API_URL}/price/${data.symbol}`).then(res => res.json()).then(p => {
                        if(p.price === undefined) return;
                        const safeEntry = parseFloat(data.entryPrice) || 0;
                        const diff = data.optionType === "CE" ? (p.price - safeEntry) : (safeEntry - p.price);
                        const pnlRs = diff * (data.lots * data.lotSize);
                        const el = document.getElementById(`fo-live-${d.id}`);
                        if(el) {
                            el.innerText = p.price.toFixed(2);
                            let pnlHTML = `<span style="color:${pnlRs>=0?'#10b981':'#ef4444'}; font-weight:bold;">${pnlRs>=0?'+‚Çπ':'-‚Çπ'}${Math.abs(pnlRs).toFixed(0)}</span>`;
                            if(pnlRs < 0) pnlHTML += `<button class="why-btn" onclick="showLossReason('fo')">‚ùì Why?</button>`;
                            document.getElementById(`fo-pnl-${d.id}`).innerHTML = pnlHTML;
                            el.classList.remove("updating"); void el.offsetWidth; el.classList.add("updating");
                        }
                    }).catch(e => console.log("Fetch error"));
                });
            };
            
            fetchLivePrices();
            liveUpdateInterval = setInterval(fetchLivePrices, 10000);
        }

        // Loss alert popup.
        window.showLossReason = (type) => {
            if (type === 'stock') {
                alert("üìâ STOCK LOSS ANALYSIS:\n\nYou are losing money because the current market price is lower than what you paid for it. This usually happens when more people are selling the stock than buying it, possibly due to bad news about the company, poor quarterly earnings, or a general market crash.");
            } else if (type === 'mf') {
                alert("üß∫ MUTUAL FUND LOSS ANALYSIS:\n\nYour Mutual Fund is down. Since a Mutual Fund holds dozens of different stocks, a loss means the broader market (like the Nifty 50) is experiencing a downturn. Don't panic! Mutual funds are designed for long-term growth and usually recover over time.");
            } else if (type === 'fo') {
                alert("‚ö° F&O LOSS ANALYSIS:\n\nYou are losing money on this contract for two possible reasons:\n1. Wrong Direction: You bought a Call (CE) but the market fell, or a Put (PE) but the market rose.\n2. Theta Decay: Options lose a tiny bit of value every single day just because time is passing, even if the market doesn't move. This is why F&O is so dangerous for beginners!");
            }
        };

        function setBtn(id, loading, defaultText) {
            const btn = document.getElementById(id);
            if(btn) { btn.disabled = loading; btn.innerText = loading ? "Processing..." : defaultText; }
        }

        window.handleTrade = async (endpoint, type) => {
            const sym = document.getElementById(type === 'mf' ? 'mf-symbol' : 'symbol').value.trim().toUpperCase();
            const qty = document.getElementById(type === 'mf' ? 'mf-quantity' : 'quantity').value.trim();
            const btnId = type === 'mf' ? 'buy-mf-btn' : 'buy-stock-btn';
            const defaultText = type === 'mf' ? 'Invest in MF' : 'Buy Stock';
            if (!sym || !qty) return alert("Please fill all fields.");
            setBtn(btnId, true, defaultText);
            try {
                const res = await fetch(`${API_URL}/${endpoint}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: auth.currentUser.uid, symbol: sym, quantity: parseInt(qty) }) });
                if (res.ok) location.reload(); else alert((await res.json()).detail);
            } catch (err) { alert("Backend Error."); }
            setBtn(btnId, false, defaultText);
        };

        window.handleSell = async (symbol, maxQty) => {
            const qty = prompt(`Sell how many shares? (Max: ${maxQty})`, maxQty);
            if (!qty || parseInt(qty) > maxQty) return;
            try {
                const res = await fetch(`${API_URL}/sell`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: auth.currentUser.uid, symbol: symbol, quantity: parseInt(qty) }) });
                if (res.ok) location.reload(); else alert((await res.json()).detail);
            } catch (err) { alert("Backend Error"); }
        };

        window.handleSellMF = async (symbol, maxQty) => {
            const qty = prompt(`Sell how many units? (Max: ${maxQty})`, maxQty);
            if (!qty || parseInt(qty) > maxQty) return;
            try {
                const res = await fetch(`${API_URL}/sell_mf`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: auth.currentUser.uid, symbol: symbol, quantity: parseInt(qty) }) });
                if (res.ok) location.reload(); else alert((await res.json()).detail);
            } catch (err) { alert("Backend Error"); }
        };

        window.handleFOTrade = async () => {
            const sym = document.getElementById('fo-symbol').value;
            const type = document.getElementById('fo-type').value;
            const lots = document.getElementById('fo-lots').value;
            if (!lots || lots <= 0) return alert("Please enter valid lots.");
            setBtn('buy-fo-btn', true, "Buy Contract");
            try {
                const res = await fetch(`${API_URL}/buy_fo`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: auth.currentUser.uid, symbol: sym, option_type: type, lots: parseInt(lots) }) });
                if (res.ok) location.reload(); else alert((await res.json()).detail);
            } catch (err) { alert("Backend Error"); }
            setBtn('buy-fo-btn', false, "Buy Contract");
        };

        window.handleCloseFO = async (symbol, type) => {
            if(!confirm(`Close all ${type} positions?`)) return;
            try {
                const res = await fetch(`${API_URL}/close_fo`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: auth.currentUser.uid, symbol: symbol, option_type: type, lots: 0 }) });
                if (res.ok) location.reload(); else alert((await res.json()).detail);
            } catch (err) { alert("Backend Error"); }
        };

        window.handleFD = async () => {
            const amt = document.getElementById('fd-amount').value.trim();
            const months = document.getElementById('fd-months').value.trim();
            if (!amt || !months) return alert("Fill fields.");
            setBtn('create-fd-btn', true, 'Open FD');
            try {
                const res = await fetch(`${API_URL}/create_fd`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: auth.currentUser.uid, amount: parseFloat(amt), duration_months: parseInt(months) }) });
                if (res.ok) location.reload(); else alert((await res.json()).detail);
            } catch (err) { alert("Backend Error"); }
            setBtn('create-fd-btn', false, 'Open FD');
        };

        window.logout = async () => { await signOut(auth); window.location.href = "index.html"; };
    </script>
</body>
</html>